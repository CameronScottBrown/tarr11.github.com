
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Setting IPRestrictions in a Windows Azure Cloud App Deployment - Douglas Tarr</title>
  <meta name="author" content="Douglas Tarr">

  
  <meta name="description" content="To set IP Restrictions in Windows Azure, you have to do 2 things, create an azure startup task in your service configuration (.cscg file), and a cmd &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://douglastarr.com/setting-iprestrictions-in-a-windows-azure-cloud-app-deployment">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Douglas Tarr" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-18064705-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Douglas Tarr</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:douglastarr.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/projects.html">Projects</a></li>
  <li><a href="/contact.html">Contact</a></li>
  <li><a href="/resume.html">Resume</a></li>
  <li><a href="/archives/">Blog Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Setting IPRestrictions in a Windows Azure Cloud App Deployment</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-24T00:00:00-08:00" pubdate data-updated="true">Feb 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><div>To set IP Restrictions in Windows Azure, you have to do 2 things, create an azure startup task in your service configuration (.cscg file), and a cmd file that runs it.</div>

<p />

<div><strong>Create a Service Configuration Startup Task to run a startup command</strong></div>

<div>

<div>&nbsp; &nbsp; &lt;Startup&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &lt;Task commandLine=&#8221;startup\ip-restrictions.cmd&#8221; executionContext=&#8221;elevated&#8221;&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;Environment&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;Variable name=&#8221;EMULATED&#8221;&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;RoleInstanceValue xpath=&#8221;/RoleEnvironment/Deployment/@emulated&#8221; /&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/Variable&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;Variable name=&#8221;RESTRICTIP&#8221;&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;RoleInstanceValue xpath=&#8221;/RoleEnvironment/CurrentInstance/ConfigurationSettings/ConfigurationSetting[@name=&#8217;RestrictIp&#8217;]/@value&#8221;/&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/Variable&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;/Environment&gt;</div>

<div>&nbsp; &nbsp; &nbsp; &lt;/Task&gt;</div>

<div>&nbsp; &nbsp; &lt;/Startup&gt;</div>

<p />

</div>

<div>

<div><strong>Create a startup command</strong>&nbsp;</div>

<p />

<div>This startup command checks the &#8220;RESTRICTIP&#8221; variable so that you can have different deployments that you can set whether or not to restrict IPs by (beta, test, production, etc). &nbsp;It also bypasses this if you are running the Azure Emulator.</div>

<p />

<div>This installs the IP Restriction Windows Role, unlocks the IIS Config, and sets the appropriate IP Restrictions (put your IP in place of 1.2.3.4)</div>

<p />

<p />

<div>

<div>if &#8220;%RESTRICTIP%&#8221;==&#8221;false&#8221; goto :EOF</div>

<div>if &#8220;%EMULATED%&#8221;==&#8221;true&#8221; goto :EOF</div>

<p />

<div>powershell Install-WindowsFeature Web-IP-Security</div>

<div>%windir%\system32\inetsrv\AppCmd.exe unlock config -section:system.webServer/security/ipSecurity</div>

<div>

<div>%windir%\system32\inetsrv\AppCmd.exe set config -section:system.webServer/security/ipSecurity /~ /commit:apphost</div>

</div>

<div>%windir%\system32\inetsrv\AppCmd.exe set config -section:system.webServer/security/ipSecurity /allowUnlisted:false /commit:apphost</div>

<div>%windir%\system32\inetsrv\AppCmd.exe set config -section:system.webServer/security/ipSecurity /+&#8221;[ipAddress=&#8217;1.2.3.4&#8217;,allowed=&#8217;True&#8217;]&#8221; /commit:apphost</div>

</div>

<p />

<p />

<div>This particular solution will not work well if you are trying to have IP restrictions on your staging deployment, and not your production deployment, since the startup command only runs on a deploy, and you will likely just swap VIPs to go from staging to production.</div>

</div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Douglas Tarr</span></span>

      








  


<time datetime="2013-02-24T00:00:00-08:00" pubdate data-updated="true">Feb 24<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/categories/azure/'>azure</a>, <a class='category' href='/categories/dev/'>dev</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://douglastarr.com/setting-iprestrictions-in-a-windows-azure-cloud-app-deployment/" data-via="tarr11" data-counturl="http://douglastarr.com/setting-iprestrictions-in-a-windows-azure-cloud-app-deployment/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/don-t-prototype-on-your-own-platform/" title="Previous Post: Don't prototype on your own platform">&laquo; Don't prototype on your own platform</a>
      
      
        <a class="basic-alignment right" href="/using-powershell-3-invoke-restmethod-with-basic-authentication-and-json/" title="Next Post: Using powershell 3 Invoke-RestMethod with Basic Authentication and JSON">Using powershell 3 Invoke-RestMethod with Basic Authentication and JSON &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
        <div><img src="/images/profile.jpg"></div>
        <p>I'm a software developer who lives in Mill Valley, California, with my wife and 2 children.</p>
	<p>My wife J'Amy is a talented fashion designer who has launched a line of <a href="http://jamytarr.com">Women's Coats and Jackets</a>.  You should check it out.</p>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/coveredca-and-anthem-problems/">CoveredCA and Anthem Problems</a>
      </li>
    
      <li class="post">
        <a href="/working-on-our-scratch-game-week-7/">Working on Our Scratch Game - Week 7</a>
      </li>
    
      <li class="post">
        <a href="/clones-and-variables-coding-class-week-6/">Clones and Variables - Coding Class Week 6</a>
      </li>
    
      <li class="post">
        <a href="/keep-your-asp-dot-net-mvc-projects-more-organized-with-partial-classes/">Keep Your ASP.NET MVC Projects Organized With Partial Classes</a>
      </li>
    
      <li class="post">
        <a href="/scratch-variables-and-lists-coding-class-week-5/">Scratch Variables and Lists - Coding Class Week 5</a>
      </li>
    
  </ul>
</section>
<a class="twitter-timeline" href="https://twitter.com/tarr11" data-widget-id="389457673361428481">Tweets by @tarr11</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Douglas Tarr -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'douglastarr';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
